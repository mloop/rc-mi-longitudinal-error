---
title: "Model formulation for pulse wave velocity measurement error project"
author: Matthew Shane Loop and Sarah Lotspeich
date: "Last updated on: `r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data story

Assume that we have collected pulse wave velocity (PWV) on a set of 2,500 participants at two time points, 5 years apart. We are interested in understanding how change in PWV may be associated with total brain volume. However, we used a different machine at the first visit than the second visit. The two machines have known measurement error. Therefore, we will try to build a model that accounts for the measurement error in each machine and estimates the estimand of interest (i.e., linear regression parameter for a 1-unit change in PWV and mean change in total brain volume).

# Notation

* Let the baseline and follow up measurements be represented by $B$ and $F$, respectively. 
* Let a measurement on the old machine and the new machine be represented by $O$ and $N$, respectively. 
* Let a "$\tilde{\dots}$" represent a random variable measured with error.
* Let a "$\hat{\dots}$" represent an estimated quantity. 

# Models for true values and values measured with error

$$PWV_{B,i} \sim N(\mu_B, \sigma_B)$$

$$PWV_{F,i} \sim N(\mu_{F,i} = \beta_0 + PWV_{B,i}\beta_1 + \mathbf{X}_i \boldsymbol{\beta}, \sigma_F)$$

$$\widetilde{PWV}_{B,i}^O \sim N(PWV_{B,i}, \sigma_B^O)$$

$$\widetilde{PWV}_{F,i}^N \sim N(PWV_{F,i}, \sigma_F^N)$$

* Assume that $\sigma_B^O = \sigma_F^O$, which is unobserved. Also assume that $\sigma_F^N = \sigma_B^N$, which is also unobserved. Neither of these unobserved quantities are of interest. We are just assuming the measurement error for a device is the same, regardless of when the measurement is taken.

These models assume a **classical measurement error model**.

For the outcome model, we are assuming the model is
$$Y_{F,i} \sim N(\mu_{Y_{F,i}} = \omega_0 + \Delta PWV_i\omega_1 + \mathbf{Z}_i\boldsymbol\omega, \sigma_{Y_F})$$
$\omega_1$ is the estimand of interest for the project.

# Calibration method

Now we describe how the calibration method might be used. Assume there is a subsample $m$ of the total sample $n$, $m \in n$. Let $i$ be an index for observations from $1,\dots,n$ and $j$ be an index for observations from $1,\dots,m$.

Assume that we conduct a calibration study where we measure $m$ subjects at time $F$ on machines $O$ and $N$. We then build the following regression model:

$$\widetilde{PWV}_{F,j}^N \sim N(\mu_{F,j}^N = \alpha_0 + \widetilde{PWV}_{F,j}^O\alpha_1, \sigma_F^{N,O})$$

After estimating the parameters of this model, we estimate the following quantity:

$$\widehat{\widetilde{PWV}}_{B,i}^N = \hat{\alpha_0} + PWV_{B,i}^O\hat{\alpha_1}$$

* The exposure of interest for the study is then $\Delta \widehat{\widetilde{PWV}}_i = \widetilde{PWV}_{F,i}^N - \widehat{\widetilde{PWV}}_{B,i}^N$
* The outcome model is $Y_{F,i} \sim N(\mu_{Y_{F,i}} = \gamma_0 + \Delta \widehat{\widetilde{PWV}}_i\gamma_1 + \mathbf{Z}_i\boldsymbol\gamma, \sigma_{Y_F})$.
* The estimand of interest is $\gamma_1$.

# Bayesian measurement error model

Now let's assume we did not do a calibration study, but know the measurement error of each device ($\sigma_B^O$ and $\sigma_F^N$). 

* The exposure is $\Delta \widehat{PWV}_i = \widehat{PWV}_{F,i} - \widehat{PWV}_{B,i}$. These unknowns are estimated simultaneously with the outcome model using Hamiltonian Monte Carlo.
* The outcome model is $Y_{F,i} \sim N(\mu_{Y_{F,i}} = \nu_0 + \Delta\widehat{PWV}_i\nu_1 + \mathbf{Z}_i\boldsymbol\nu, \sigma_{Y_F})$.
* The estimand of interest is $\nu_1$.

# Hypothesis of simulation study

We are assuming that $\hat{\nu}_1$ is less biased for $\omega_1$ than $\hat{\gamma}_1$ is for $\omega_1$.

We are also technically assuming truncated normal distributions for $PWV$ and its measurements $\widetilde{PWV}$ in the simulation study.