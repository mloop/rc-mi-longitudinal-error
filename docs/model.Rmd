---
title: "Model"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data story

Assume that we have collected pulse wave velocity (PWV) on a set of 2,500 participants at two time points, 5 years apart. However, we used a different machine at the first visit than the second visit. The two machines have known measurement error. Therefore, we will try to build a model that can use both measurements to calculate a valid 5-year difference in PWV.

# Fake data simulation

$$
PWV_{1, i} \sim truncNorm(\mu = 1100, \sigma = 350, a = 350, b = 2400)
$$

$$
PWV_{2, i} \sim truncNorm(\mu = 1120 + 0.9 * centered\_scaled(PWV_{1,i}) - 5 * female_i, \sigma = 50, a = 350, 5 = 2400)
$$

Each of these quantities, PWV at visits 1 and 2, are measured with error. The error is generated as follows:

$$
PWV\_measured_{1,i} \sim truncNorm(\mu = PWV_{1,i}, sigma = 112.8, a = 350, b = 2400)
$$

$$
PWV\_measured_{2,i} \sim truncNorm(\mu = PWV_{2,i}, sigma = 22.4, a = 350, b = 2400)
$$

The measurement error for the machine used at visit 2 was much smaller.

# Model

The likelihood of the model being fit is:

```
pwv_visit1 ~ normal(mu_pwv_1, sigma_pwv_1);
pwv_visit1_measured ~ normal(pwv_visit1, 112.8);
pwv_visit2_measured ~ normal(pwv_visit2, 22.4);
pwv_visit2 ~ normal(beta_0 + beta_1 * female + beta_2 * pwv_visit1, sigma);
```

with priors

```
beta_0 ~ normal(1100, 350);
sigma ~ student_t(50, 3, 10);
beta_1 ~ normal(0, 1);
beta_2 ~ normal(0, 1);
mu_pwv_1 ~ normal(1100, 100);
sigma_pwv_1 ~ student_t(1100, 300, 100);
```
# Problem

* I am having a great deal of trouble getting an identifiable model. Specifically, after 5,000 iterations, the `Rhat` for the variance of the PWV at visit 1 is still 2.1. The effect of female sex (`beta_1`) is way off. It should be -5, but it's -0.5. All other parameters seem to be estimated alright. The residual variance is overestimated by about 20%.

**Why is the effect of female sex underestimated so severely?**